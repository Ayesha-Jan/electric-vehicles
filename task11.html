<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Task 11: Main Visualization</title>

  <!-- D3.js -->
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Leaflet MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    body { font-family: sans-serif; margin:0; padding:0; }
    h1 { text-align: center; margin: 20px 0; }
    #controls { text-align:center; margin: 15px; }
    #map { height: 500px; width: 90%; margin: 20px auto; display: block; }
    #chart svg { display: block; margin: auto; max-width: 100%; height: 500px; width: 100%; }
    .loading { text-align:center; font-size:18px; padding:20px; }
    .legend { font-size: 12px; }
  </style>
</head>
<body>

  <h1>Task 11: EV Adoption and Clean Electricity</h1>
  <div id="controls">
    <label for="yearSelect"><b>Select Year:</b></label>
    <select id="yearSelect"></select>
    <div id="legend"></div>
  </div>

  <div class="loading" id="loading">Loading data...</div>
  <div id="map"></div>
  <div id="chart"></div>
  <div id="legend"></div>

  <script>
  // =============================
  // Setup SVG for Scatter Plot
  // =============================
  const margin = {top: 20, right: 30, bottom: 50, left: 70};
  const width = 800 - margin.left - margin.right;
  const height = 500 - margin.top - margin.bottom;

  const svg = d3.select("#chart")
    .append("svg")
    .attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`)
    .append("g")
    .attr("transform", `translate(${margin.left},${margin.top})`);

  const xScale = d3.scaleLinear().range([0, width]);
  const yScale = d3.scaleLinear().range([height, 0]);
  const sizeScale = d3.scaleSqrt().range([3, 20]);
  const colorScale = d3.scaleSequential(d3.interpolateRgb("pink", "steelblue"));

  svg.append("g").attr("class","x-axis").attr("transform", `translate(0, ${height})`);
  svg.append("g").attr("class","y-axis");

  svg.append("text").attr("class","x-label")
    .attr("x", width/2).attr("y", height+40)
    .attr("text-anchor","middle").text("Clean Electricity Share (%)");

  svg.append("text").attr("class","y-label")
    .attr("transform","rotate(-90)")
    .attr("x",-height/2).attr("y",-55)
    .attr("text-anchor","middle").text("EV Sales");

  // =============================
  // Leaflet Map Setup
  // =============================
  const map = L.map('map').setView([20,0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  let leafletLayer; // marker cluster group

  // =============================
  // Data Loading
  // =============================
  d3.json("data/master_data.geojson").then(geoData => {
    const masterData = geoData.features.map(f => {
      const p = f.properties;
      return {
        Country: p.Country,
        Year: +p.Year,
        EV: +p.EV,
        CleanElec: +p.CleanElec,
        lat: f.geometry.coordinates[1],
        lon: f.geometry.coordinates[0]
      };
    });

    d3.select("#loading").style("display","none");

    // Year dropdown
    const years = ["All years", ...d3.range(2010, 2021)];
    const select = d3.select("#yearSelect");
    select.selectAll("option")
      .data(years)
      .enter().append("option")
      .text(d => d)
      .attr("value", d => d);

    select.on("change", function() {
      const year = this.value;
      const filtered = (year==="All years") ? masterData : masterData.filter(d => d.Year === +year);
      updateChart(filtered);
      updateMap(filtered);
    });

    // Initial state
    select.property("value", "All years");
    updateChart(masterData);
    updateMap(masterData);
    drawLegend(); // add legend once

    // =============================
    // Update Scatter Plot
    // =============================
    function updateChart(data) {
      xScale.domain([0, d3.max(data, d => d.CleanElec)]).nice();
      yScale.domain([0, d3.max(data, d => d.EV)]).nice();
      sizeScale.domain([0, d3.max(data, d => d.EV)]);
      colorScale.domain([0, d3.max(data, d => d.CleanElec)]);

      svg.select(".x-axis").transition().duration(500).call(d3.axisBottom(xScale));
      svg.select(".y-axis").transition().duration(500).call(d3.axisLeft(yScale));

      const circles = svg.selectAll("circle").data(data, d => d.Country + d.Year);

      circles.enter().append("circle")
        .attr("opacity", 0.9)
        .merge(circles)
        .transition().duration(500)
        .attr("cx", d => xScale(d.CleanElec))
        .attr("cy", d => yScale(d.EV))
        .attr("r", d => sizeScale(d.EV))
        .attr("fill", d => colorScale(d.CleanElec));

      circles.exit().remove();
    }

    // =============================
    // Update Leaflet Map
    // =============================
    function updateMap(data) {
      if (leafletLayer) map.removeLayer(leafletLayer);
      leafletLayer = L.markerClusterGroup();

      data.forEach(d => {
        const marker = L.circleMarker([d.lat, d.lon], {
          radius: 4 + sizeScale(d.EV)/2,
          fillColor: colorScale(d.CleanElec),
          color: "#333",
          weight: 1,
          fillOpacity: 0.9
        }).bindPopup(`
          <b>${d.Country} (${d.Year})</b><br>
          EV Sales: ${d.EV.toLocaleString()}<br>
          Clean Electricity: ${d.CleanElec}%
        `);
        leafletLayer.addLayer(marker);
      });

      leafletLayer.addTo(map);
    }
  });
  </script>

</body>
</html>