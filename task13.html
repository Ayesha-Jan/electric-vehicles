<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Task 13: Legends and Annotations</title>

        <!-- D3.js -->
        <script src="https://d3js.org/d3.v7.min.js"></script>
        <script src="https://unpkg.com/d3-svg-annotation@2.5.1/d3-annotation.min.js"></script>

        <!-- Leaflet -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
        <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

        <!-- Leaflet MarkerCluster -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
        <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
        <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

        <style>
            body { font-family: sans-serif; margin:0; padding:0; }
            h1, h2 { text-align: center; margin: 20px 0; }
            p { text-align:center; font-size:14px; color:gray; }
            .container { width: 92%; max-width: 1200px; margin: 0 auto; }
            #controls { text-align:center; margin: 15px; }
            #map { width: 100%; height: 520px; margin: 10px 0; }
            #chart { width: 100%; height: 480px; margin: 10px 0; display:block; }
            #map, #chart { border: 2px solid #d27d87; border-radius: 8px; padding: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
            #tooltip { position:absolute; background:white; border:1px solid #ccc; padding:6px; display:none; pointer-events:none; }
            .loading { text-align:center; font-size:18px; padding:20px; }
            .legend { font-size:12px; }
        </style>
        
    </head>
    <body>
        <div class = "container">
            <h1>Does Clean Electricity Drive Electric Vehicle Adoption?</h1>
            <div id="controls">
                <label for="yearSelect"><b>Select Year:</b></label>
                <select id="yearSelect"></select>

                <label for="regionSelect"><b>Select Region:</b></label>
                <select id="regionSelect"></select>
            </div>
            <div class="loading" id="loading">Loading data...</div>
            
            <!-- Map title -->
            <h2>Global Electric Vehicle Adoption & Clean Electricity</h2>
            <p>Circle color shows clean electricity share, circle size shows EV sales.</p>
            <div id="map"></div>

            <!-- Scatter plot title -->
            <h2>Clean Electricity Share vs. Electric Vehicle Sales</h2>
            <p>Each bubble represents a country in the selected year/region.</p>
            <div id="chart"></div>

        </div>
        <div id="tooltip"></div>

        <script>

            // =============================
            // Setup SVG for Scatter Plot
            // =============================

            const chartDiv = document.getElementById('chart');
            const chartWidth = chartDiv.clientWidth;
            const chartHeight = 440;
            const margin = {top: 30, right: 30, bottom: 60, left: 70};
            const innerW = chartWidth - margin.left - margin.right;
            const innerH = chartHeight - margin.top - margin.bottom;

            const svg = d3.select("#chart")
                .append("svg")
                .attr("width", chartWidth)
                .attr("height", chartHeight)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const xScale = d3.scaleLinear().range([0, innerW]);
            const yScale = d3.scaleLinear().range([innerH, 0]);
            const sizeScale = d3.scaleSqrt().range([3, 20]);
            const colorScale = d3.scaleSequential(d3.interpolateRgb("pink", "steelblue"));

            // Axes
            svg.append("g").attr("class","x-axis").attr("transform", `translate(0, ${innerH})`);
            svg.append("g").attr("class","y-axis");

            // Labels
            svg.append("text")
                .attr("class","x-label")
                .attr("x", innerW/2)
                .attr("y", innerH + 48)
                .attr("text-anchor","middle").text("Clean Electricity Share (%)");

            svg.append("text")
                .attr("class","y-label")
                .attr("x", -innerH / 2)       
                .attr("y", -50)              
                .attr("transform", "rotate(-90)")
                .attr("text-anchor", "middle")
                .text("Electric Cars Sold");

            // Zoom
            const zoom = d3.zoom()
                .scaleExtent([0.5, 10])
                .translateExtent([[0, 0], [chartWidth, chartHeight]])
                .on("zoom", zoomed);

            d3.select("svg").call(zoom);
            function zoomed({transform}) {
                const newX = transform.rescaleX(xScale);
                const newY = transform.rescaleY(yScale);

                svg.selectAll("circle")
                    .attr("cx", d => newX(d.CleanElec))
                    .attr("cy", d => newY(d.EV));

                svg.select(".x-axis").call(d3.axisBottom(newX));
                svg.select(".y-axis").call(d3.axisLeft(newY));
            }

            // Tooltip
            const tooltip = d3.select("#tooltip");

            // =============================
            // Leaflet Map Setup
            // =============================

            const map = L.map('map').setView([20,0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 18,
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            let leafletLayer;
            const markerMap = {}; 

            // =============================
            // Data Load
            // =============================

            d3.json("data/master_data.geojson").then(geoData => {
                const masterData = geoData.features.map(f => {
                    const p = f.properties;
                    return {
                        Country: p.Country,
                        Region: p.Region,
                        Year: +p.Year,
                        EV: +p.EV,
                        CleanElec: +p.CleanElec,
                        lat: f.geometry.coordinates[1],
                        lon: f.geometry.coordinates[0]
                    };
                });

                let currentData = masterData;

                d3.select("#loading").style("display","none");

                // Year dropdown
                const years = ["All years", ...d3.range(2010, 2021)];
                const yearSelect = d3.select("#yearSelect");
                yearSelect.selectAll("option")
                    .data(years)
                    .enter().append("option")
                    .text(d => d)
                    .attr("value", d => d);

                // Region dropdown
                const regions = ["All regions", ...Array.from(new Set(masterData.map(d => d.Region)))];
                const regionSelect = d3.select("#regionSelect");

                regionSelect.selectAll("option")
                    .data(regions)
                    .enter().append("option")
                    .text(d => d)
                    .attr("value", d => d);

                // =============================
                // Filter Function
                // =============================

                function filterData() {
                    const year = yearSelect.property("value");
                    const region = regionSelect.property("value");

                    let filtered = masterData;

                    if (year !== "All years") filtered = filtered.filter(d => d.Year === +year);
                    if (region !== "All regions") filtered = filtered.filter(d => d.Region === region);

                    currentData = filtered;
                    updateChart(currentData);
                    updateMap(currentData);

                    // Reset zoom on filtering
                    d3.select("svg").transition().duration(500).call(zoom.transform, d3.zoomIdentity);
                }

                yearSelect.on("change", filterData);
                regionSelect.on("change", filterData);

                // =============================
                // Brush
                // =============================
                const brush = d3.brush()
                    .extent([[0,0], [innerW, innerH]])
                    .on("end", brushed);

                svg.append("g").attr("class", "brush").call(brush);

                function brushed({selection}) {
                    if (!selection) {
                        updateMap(currentData);
                        return;
                    }
                    const [[x0,y0],[x1,y1]] = selection;
                    const selected = currentData.filter(d => {
                        const cx = xScale(d.CleanElec);
                        const cy = yScale(d.EV);
                        return cx >= x0 && cx <= x1 && cy >= y0 && cy <= y1;
                    });
                    updateMap(selected);

                    // Zoom map to selection
                    if (selected.length > 0) {
                        const bounds = L.latLngBounds(selected.map(d => [d.lat, d.lon]));
                        map.fitBounds(bounds, { padding: [30, 30], maxZoom: 5 });
                    };
                }

                // Initial state
                yearSelect.property("value", "All years");
                regionSelect.property("value", "All regions");
                filterData();
                d3.select("svg").transition().duration(500).call(zoom.transform, d3.zoomIdentity);

                // =============================
                // Update Scatter Plot
                // =============================

                function updateChart(data) {
                    xScale.domain([0, d3.max(data, d => d.CleanElec)]).nice();
                    yScale.domain([0, d3.max(data, d => d.EV)]).nice();
                    sizeScale.domain([0, d3.max(data, d => d.EV)]);
                    colorScale.domain([0, d3.max(data, d => d.CleanElec)]);

                    svg.select(".x-axis").transition().duration(500).call(d3.axisBottom(xScale));
                    svg.select(".y-axis").transition().duration(500).call(d3.axisLeft(yScale));

                    const circles = svg.selectAll("circle").data(data, d => d.Country + d.Year);

                    circles.enter().append("circle")
                        .attr("opacity", 0.9)
                        .on("mouseover", (event, d) => {
                            tooltip.style("display","block")
                            .html(`<b>${d.Country}</b><br>EV: ${d.EV.toLocaleString()}<br>Clean Elec: ${(d.CleanElec).toFixed(2)}%`);
                            // Highlight map marker
                            const key = d.Country + d.Year;
                            if (markerMap[key]) markerMap[key].setStyle({color:"yellow", weight:3});
                        })
                        .on("mousemove", event => {
                            tooltip.style("left", (event.pageX+10)+"px")
                                .style("top", (event.pageY-20)+"px");
                        })
                        .on("mouseout", (event, d) => {
                            tooltip.style("display","none");
                            const key = d.Country + d.Year;
                            if (markerMap[key]) markerMap[key].setStyle({color:"#333", weight:1});
                        })
                        .on("click", (event, d) => {
                            const latlng = L.latLng(d.lat, d.lon);
                            map.flyTo(latlng, 4, { animate: true, duration: 1 }); 
                            const marker = markerMap[d.Country + d.Year];
                            if (marker) marker.openPopup();
                        })
                        .merge(circles)
                        .transition().duration(500)
                        .attr("cx", d => xScale(d.CleanElec))
                        .attr("cy", d => yScale(d.EV))
                        .attr("r", d => sizeScale(d.EV))
                        .attr("fill", d => colorScale(d.CleanElec));

                    circles.exit().remove();

                    // =============================
                    // D3 Annotations
                    // =============================
                    svg.selectAll(".annotation-group").remove();
                    const annotations = [];
                    data.filter(d=>d.EV>d3.max(data,d=>d.EV)*0.8).forEach(d=>{
                        annotations.push({
                            note:{label:`High EV`, title:d.Country},
                            x:xScale(d.CleanElec),
                            y:yScale(d.EV),
                            dy:-30, dx:20
                        });
                    });
                    if(annotations.length>0){
                        const makeAnnotations = d3.annotation().annotations(annotations);
                        svg.append("g").attr("class","annotation-group").call(makeAnnotations);
                    }

                    updateLegends(data);
                }

                // =============================
                // Update Leaflet Map
                // =============================

                function updateMap(data) {
                    if (leafletLayer) map.removeLayer(leafletLayer);
                    leafletLayer = L.markerClusterGroup();
                    Object.keys(markerMap).forEach(k => delete markerMap[k]);

                    data.forEach(d => {
                        const marker = L.circleMarker([d.lat, d.lon], {
                        radius: 4 + sizeScale(d.EV)/2,
                        fillColor: colorScale(d.CleanElec),
                        color: "#333",
                        weight: 1,
                        fillOpacity: 0.9
                        }).bindPopup(`
                        <b>${d.Country} (${d.Year})</b><br>
                        EV Sales: ${d.EV.toLocaleString()}<br>
                        Clean Electricity: ${(d.CleanElec).toFixed(2)}%
                        `);

                        // Link back to chart
                        marker.on("mouseover", () => {
                        d3.selectAll("circle")
                            .filter(c => c.Country===d.Country && c.Year===d.Year)
                            .classed("highlight", true);
                        });
                        marker.on("mouseout", () => {
                            d3.selectAll("circle").classed("highlight", false);
                        });

                        markerMap[d.Country + d.Year] = marker;
                        leafletLayer.addLayer(marker);
                    });

                    leafletLayer.addTo(map);

                    // Zoom map to fit filtered data
                    if (data.length > 0) {
                        const bounds = L.latLngBounds(data.map(d => [d.lat, d.lon]));
                        map.fitBounds(bounds, { padding: [30, 30] });
                    }
                }

                // =============================
                // Legends
                // =============================

                function updateLegends(data){
                    d3.selectAll(".color-legend").remove();
                    d3.selectAll(".size-legend").remove();

                    // Color Legend (top-right)
                    const colorLegend = svg.append("g")
                        .attr("class","color-legend")
                        .attr("transform",`translate(${innerW - 120},20)`);

                    colorLegend.append("text")
                        .attr("x",0).attr("y",-5)
                        .style("font-weight","bold")
                        .text("Clean Electricity (%)");

                    const legendData = d3.range(0, d3.max(data,d=>d.CleanElec), 20);
                    colorLegend.selectAll("rect").data(legendData).enter()
                        .append("rect")
                        .attr("x",0).attr("y",(d,i)=> i*20)
                        .attr("width",15).attr("height",15)
                        .attr("fill",d=>colorScale(d));

                    colorLegend.selectAll("text.label").data(legendData).enter()
                        .append("text")
                        .attr("class","label")
                        .attr("x",20).attr("y",(d,i)=> i*20+12)
                        .text(d=>d+"%");

                    // Size Legend (below color legend)
                    const sizeLegend = svg.append("g")
                        .attr("class","size-legend")
                        .attr("transform",`translate(${innerW - 120},${legendData.length*20 + 50})`);

                    sizeLegend.append("text")
                        .attr("x",0).attr("y",-5)
                        .style("font-weight","bold")
                        .text("EV Sales (bubble size)");

                    const sizeValues = [50000,200000,500000];
                    sizeLegend.selectAll("circle").data(sizeValues).enter()
                        .append("circle")
                        .attr("cy",(d,i)=>i*40)
                        .attr("r",d=>sizeScale(d))
                        .attr("fill","steelblue")
                        .attr("opacity",0.5);

                    sizeLegend.selectAll("text.label").data(sizeValues).enter()
                        .append("text")
                        .attr("class","label")
                        .attr("x",40).attr("y",(d,i)=>i*40+5)
                        .text(d=>d.toLocaleString());
                }
                // =============================
                // Leaflet Map Legend
                // =============================

                // Leaflet Color Legend
                const legend = L.control({position:"bottomright"});
                legend.onAdd = function(map){
                    const div = L.DomUtil.create("div","info legend");
                    div.innerHTML += "<b>Clean Electricity Share</b><br>";
                    const grades=[0,20,40,60,80,100];
                    grades.forEach((g,i)=>{
                        div.innerHTML +=
                        `<i style="background:${colorScale(g)}; width:18px; height:18px; display:inline-block; margin-right:5px"></i>
                        ${g}${grades[i+1] ? '&ndash;'+grades[i+1]+'%<br>' : '%+'}`;
                    });

                    div.innerHTML += "<br><b>EV Sales (circle size)</b><br>";
                    div.innerHTML += '<svg width="100" height="60">' +
                        '<circle cx="20" cy="20" r="5" fill="gray" opacity="0.6"/><text x="40" y="25" font-size="12">50k</text>' +
                        '<circle cx="20" cy="45" r="15" fill="gray" opacity="0.6"/><text x="40" y="50" font-size="12">500k</text>' +
                        '</svg>';

                    return div;
                };
                legend.addTo(map);
                L.control.scale({metric:true, imperial:false}).addTo(map);
            });
        </script>
    </body>
</html>